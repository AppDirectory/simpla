<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Simpla</title>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>

    <script>
      sinon.stub(document.head, 'appendChild');
    </script>

    <script src="/simpla.js"></script>
  </head>
  <body>
    <script>
      describe('Simpla', function() {
        beforeEach(function() {
          document.head.appendChild.reset();
        });

        it('should expose global Simpla variable', function() {
          expect(window.Simpla).to.be.ok;
          expect(window.Simpla).to.be.a.function;
        });

        describe('initialization', function() {
          it('setup the correct state ', function() {
            var client = Simpla('project-key');
            expect(Simpla.client).to.equal(client);
          });

          xit('on subsequent calls it should warn', function() {
            if (!Simpla.client) {
              Simpla('project-key');
            }

            var client = Simpla.client;
            sinon.spy(console, 'warn');
            Simpla('project-key');
            expect(client).to.equal(Simpla.client);
            expect(console.warn.called).to.be.true;
            console.warn.restore();
          });

          it('should set correct options in the state', function() {
            Simpla({
              project: 'project-key'
            });

            expect(Simpla.getState().options.dataEndpoint).to.equal('https://api.simpla.io/projects/project-key/items');
          });

          it('should setup project if given only the project key', function() {
            Simpla('another-project-key');

            expect(Simpla.getState().options.dataEndpoint).to.equal('https://api.simpla.io/projects/another-project-key/items');
          });

          describe('element imports', function() {
            var defaults = [
                  'https://elements.simpla.io/simpla-img/simpla-img.html',
                  'https://elements.simpla.io/simpla-text/simpla-text.html',
                  'https://elements.simpla.io/simpla-block/simpla-block.html',
                  'https://elements.simpla.io/sm-admin/sm-admin.html'
                ],
                bower = [
                  '/bower_componenst/simpla-img/simpla-img.html',
                  '/bower_componenst/simpla-text/simpla-text.html',
                  '/bower_componenst/simpla-block/simpla-block.html',
                  '/bower_componenst/sm-admin/sm-admin.html'
                ];

            function getImportKeys() {
              return Object.keys(Simpla.getState().imports);
            }

            function resolveUrls(urls = []) {
              return urls.map(href => {
                var link = document.createElement('link');
                link.href = href;
                // This will return the fully resolved url which is what we expect
                return link.href;
              });
            }

            it('should have the right default, if excluded or only key is used', function() {
              Simpla('project-key');
              expect(getImportKeys()).to.deep.equal(defaults);

              Simpla({ project: 'project-key' });
              expect(getImportKeys()).to.deep.equal(defaults);
            });

            it('should mix defaults with a given elements object', function() {
              Simpla({
                project: 'project-key',
                elements: {
                  base: '/bower_components/'
                }
              });

              expect(getImportKeys()).to.deep.equal(resolveUrls(bower));
            });

            it('should make an empty array if given a falsy value', function() {
              Simpla({
                project: 'project-key',
                elements: null
              });

              expect(getImportKeys()).to.deep.equal([]);
            });

            it('should allow elements to be an array', function() {
              var paths = [ 'foo' ];

              Simpla({
                project: 'project-key',
                elements: paths
              });

              expect(getImportKeys()).to.deep.equal(resolveUrls(paths));
            });
          });
        });

        xdescribe('loading elements', function() {
          it('should call appendChild on document.head', function() {
            var base = 'foo',
                elements = ['bar', 'qux'],
                links;

            SimplaClass.loadElements(elements, base);

            expect(document.head.appendChild.callCount).to.equal(elements.length);

            elements
              .map(function(el) {
                return base + el;
              })
              .forEach(function(href, i) {
                var call = document.head.appendChild.getCall(i),
                    link = call.args[0],
                    dummyLink = document.createElement('link');

                dummyLink.href = href;
                expect(link.rel).to.equal('import');
                expect(link.href).to.equal(dummyLink.href);
              });

            document.head.appendChild.reset();
          });
        });

        describe('bootscript', function() {
          /**
           * NOTE: This is currently disabled as Firefox and Safari seem to struggle
           * 	with this test, testing the boot function manually seems to work fine
           */
          xit('should set up polymer', function() {
            expect(window.Polymer).to.be.ok;
            expect(window.Polymer.dom).to.equal('shadow');
          });

          /**
           * NOTE: This should work in theory, but I believe because the tests are
           * 	isolated, it's not referencing the right head object. Disabling for now
           */
          xit('should hide <default-content> elements', function(done) {
            var el = document.createElement('default-content'),
                styles;

            document.body.appendChild(el);
            styles = window.getComputedStyle(el);
            expect(styles.display).to.equal('none');
          });
        });
      });
    </script>
  </body>
</html>
