<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Simpla</title>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>

    <script>
      sinon.stub(document.head, 'appendChild');
    </script>

    <script src="/simpla.js"></script>
  </head>
  <body>
    <script>
      describe('Simpla', function() {
        var SimplaClass = Simpla.constructor;

        beforeEach(function() {
          document.head.appendChild.reset();
        });

        it('should expose global Simpla variable', function() {
          expect(window.Simpla).to.be.ok;
          expect(window.Simpla).to.be.a.function;
        });

        describe('constructor', function() {
          it('should create a singleton on .client', function() {
            var client = Simpla('project-key');
            expect(Simpla.client).to.equal(client);
          });

          it('on subsequent calls it should warn', function() {
            if (!Simpla.client) {
              Simpla('project-key');
            }

            var client = Simpla.client;
            sinon.spy(console, 'warn');
            Simpla('project-key');
            expect(client).to.equal(Simpla.client);
            expect(console.warn.called).to.be.true;
            console.warn.restore();
          });
        });

        describe('class', function() {
          var simpla;

          it('should set the config up', function() {
            simpla = new SimplaClass({
              project: 'project-key'
            });

            expect(simpla.options.api.data).to.equal('https://api.simpla.io/projects/project-key');
          });

          it('should setup project if given only the project key', function() {
            simpla = new SimplaClass('another-project-key');

            expect(simpla.options.api.data).to.equal('https://api.simpla.io/projects/another-project-key');
          });

          describe('element setup', function() {
            var defaults = {
                  base: 'https://elements.simpla.io/',
                  paths: [
                    'simpla-img/simpla-img.html',
                    'simpla-text/simpla-text.html',
                    'simpla-block/simpla-block.html',
                    'sm-admin/sm-admin.html'
                  ]
                };

            it('should have the right default, if excluded or only key is used', function() {
              simpla = new SimplaClass('project-key');
              expect(simpla.options.elements).to.deep.equal(defaults);

              simpla = new SimplaClass({
                project: 'project-key'
              });
              expect(simpla.options.elements).to.deep.equal(defaults);
            });

            it('should mix defaults with a given elements object', function() {
              var expected = Object.assign({}, defaults, { base: '/bower_components/'});
              simpla = new SimplaClass({
                project: 'project-key',
                elements: {
                  base: '/bower_components/'
                }
              });

              expect(simpla.options.elements).to.deep.equal(expected);
            });

            it('should make an empty array if given a falsy value', function() {
              var expected = Object.assign({}, defaults, { paths: [] });
              simpla = new SimplaClass({
                project: 'project-key',
                elements: null
              });

              expect(simpla.options.elements).to.deep.equal(expected);
            });

            it('should allow elements to be an array', function() {
              var paths = [ 'foo' ],
                  expected = Object.assign({}, defaults, { paths: paths });

              simpla = new SimplaClass({
                project: 'project-key',
                elements: paths
              });

              expect(simpla.options.elements).to.deep.equal(expected);
            });
          });
        });

        describe('loading elements', function() {
          it('should call appendChild on document.head', function() {
            var base = 'foo',
                elements = ['bar', 'qux'],
                links;

            SimplaClass.loadElements(elements, base);

            expect(document.head.appendChild.callCount).to.equal(elements.length);

            elements
              .map(function(el) {
                return base + el;
              })
              .forEach(function(href, i) {
                var call = document.head.appendChild.getCall(i),
                    link = call.args[0],
                    dummyLink = document.createElement('link');

                dummyLink.href = href;
                expect(link.rel).to.equal('import');
                expect(link.href).to.equal(dummyLink.href);
              });

            document.head.appendChild.reset();
          });
        });

        describe('bootscript', function() {
          /**
           * NOTE: This is currently disabled as Firefox and Safari seem to struggle
           * 	with this test, testing the boot function manually seems to work fine
           */
          xit('should set up polymer', function() {
            expect(window.Polymer).to.be.ok;
            expect(window.Polymer.dom).to.equal('shadow');
          });

          /**
           * NOTE: This should work in theory, but I believe because the tests are
           * 	isolated, it's not referencing the right head object. Disabling for now
           */
          xit('should hide <default-content> elements', function(done) {
            var el = document.createElement('default-content'),
                styles;

            document.body.appendChild(el);
            styles = window.getComputedStyle(el);
            expect(styles.display).to.equal('none');
          });
        });
      });
    </script>
  </body>
</html>
