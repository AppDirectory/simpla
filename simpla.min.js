!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Simpla=e()}(this,function(){"use strict";function t(t){return window.btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode("0x"+e)}))}function e(t){switch(_.call(t)){case"[object String]":case"[object Number]":case"[object Boolean]":case"[object Null]":case"[object Undefined]":return!0}return!1}function n(t,r){var o=void 0;return _.call(t)===_.call(r)&&(e(t)?t===r:Array.isArray(t)?t.length===r.length&&t.every(function(t){return function(e,r){return n(e,t[r])}}(r)):(o=Object.keys(t)).length===Object.keys(r).length&&o.every(function(t,e){return function(r){return r in t&&r in e&&n(t[r],e[r])}}(t,r)))}function r(t){if(e(t))return t;if(Array.isArray(t))return t.map(r);var n=Object.create(null);for(var o in t)n[o]=r(t[o]);return n}function o(){return Math.random().toString(32).slice(-5)}function i(t){if(0!==t.indexOf("/"))throw new Error("Invalid path '"+t+"'. Path must start with leading '/'")}function a(t){if(null!==t){var e=["data","type","path","createdAt","updatedAt"],n=Object.keys(t);if("data"in t&&("object"!==l(t.data)||null===t.data))throw new TypeError("'data' property in item must be a non-null object. Got "+l(t.data));if("type"in t&&"string"!=typeof t.type&&null!==t.type)throw new TypeError("'type' property in item must be a string or null. Got "+l(t.type));var r=!0,o=!1,i=void 0;try{for(var a,u=n[Symbol.iterator]();!(r=(a=u.next()).done);r=!0){var s=a.value;if(-1===e.indexOf(s))throw new Error("Invalid property "+s+". Valid properties are "+e.slice(0,-1).join(", ")+" or "+e[e.length-1]+".")}}catch(t){o=!0,i=t}finally{try{!r&&u.return&&u.return()}finally{if(o)throw i}}}}function u(t){var e=[],n=void 0,r=function(t,n,r){var i=o()+"."+n,a="[upload "+i+"]";return e.push([i,r]),a};return n=c(t,function(t){return"string"==typeof t?t.replace(/data:image\/(.+?);base64,([A-Za-z0-9+/=]+)/g,r):t}),[n,e]}function s(t){return function(e){var n=m(e,1)[0];return!t||!t[n]||t[n].modified}}function c(t,e){if(Array.isArray(t))return t.map(function(t){return c(t,e)});if("object"===(void 0===t?"undefined":l(t))&&null!==t){var n=Object.create(null);for(var r in t)n[r]=c(t[r],e);return n}return e(t)}function h(){}var f="function"==typeof fetch?fetch.bind():function(t,e){return e=e||{},new Promise(function(n,r){function o(){var t,e=[],n=[],r={};return i.getAllResponseHeaders().replace(/^(.*?):\s*([\s\S]*?)$/gm,function(o,i,a){e.push(i=i.toLowerCase()),n.push([i,a]),t=r[i],r[i]=t?t+","+a:a}),{ok:1==(i.status/200|0),status:i.status,statusText:i.statusText,url:i.responseURL,clone:o,text:function(){return Promise.resolve(i.responseText)},json:function(){return Promise.resolve(i.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([i.response]))},headers:{keys:function(){return e},entries:function(){return n},get:function(t){return r[t.toLowerCase()]},has:function(t){return t.toLowerCase()in r}}}}var i=new XMLHttpRequest;i.open(e.method||"get",t);for(var a in e.headers)i.setRequestHeader(a,e.headers[a]);i.withCredentials="include"==e.credentials,i.onload=function(){n(o())},i.onerror=r,i.send(e.body)})},l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v=(function(){function t(t){this.value=t}function e(e){function n(o,i){try{var a=e[o](i),u=a.value;u instanceof t?Promise.resolve(u.value).then(function(t){n("next",t)},function(t){n("throw",t)}):r(a.done?"return":"normal",a.value)}catch(t){r("throw",t)}}function r(t,e){switch(t){case"return":o.resolve({value:e,done:!0});break;case"throw":o.reject(e);break;default:o.resolve({value:e,done:!1})}(o=o.next)?n(o.key,o.arg):i=null}var o,i;this._invoke=function(t,e){return new Promise(function(r,a){var u={key:t,arg:e,resolve:r,reject:a,next:null};i?i=i.next=u:(o=i=u,n(t,e))})},"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)}}(),function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),d=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),p=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},y=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},b=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},m=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&u.return&&u.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_=Object.prototype.toString,g=/\[upload\s(.+)\]/g,w=function(){function t(e){var n=e.data,r=e.uploads,o=e.cacheBusting;v(this,t),this.contentUrl=n,this.uploadsUrl=r,this.cacheBusting=o}return d(t,[{key:"get",value:function(t){var e=this,n=function(t){return"string"==typeof t?t.replace(g,e.uploadsUrl+"/$1"):t},r=""+this.contentUrl+t+".json";return this.cacheBusting&&(r+="?time="+Date.now()),f(r).then(function(t){return 404===t.status?null:t.json()}).then(function(t){return c(t,n)})}}]),t}(),k=function(){function e(t){var n=t.repo,r=t.data,o=void 0===r?"data":r,i=t.uploads,a=void 0===i?"uploads":i,u=t.branch,s=void 0===u?"master":u,c=t.credentials,h=void 0===c?null:c;v(this,e),this.repo=n,this.branch=s,this.paths={data:o,uploads:a},this.credentials=h}return d(e,[{key:"_request",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.method,r=void 0===n?"GET":n,o=e.body,i="https://api.github.com/repos/"+this.repo+"/"+t,a={Authorization:"token "+this.credentials.token};return o=o&&JSON.stringify(o),this.credentials.token?f(i,{method:r,body:o,headers:a}).then(function(t){return 204===t.status?null:t.json().then(function(e){if(!t.ok&&404!==t.status)throw e;return e})}):Promise.reject(new Error('Could not make request to GitHub, invalid token "'+this.credentials.token+'"'))}},{key:"_enqueue",value:function(t){return this._waitFor?this._waitFor=this._waitFor.then(t):this._waitFor=Promise.resolve().then(t),this._waitFor}},{key:"all",value:function(){var t=this,e=this.paths.data.split("/"),n=e.pop(),r=e.join("/"),o=function(e){var r=e.find(function(t){return t.name===n});if(!r)throw new Error('Could not find folder "'+t.paths.data+'"');return t._request("git/trees/"+r.sha+"?recursive=1")},i=function(t){return t.tree.filter(function(t){return"blob"===t.type}).map(function(t){return"/"+t.path.replace(".json","")})};return this._enqueue(function(){return t._request("contents"+r+"?ref="+t.branch).then(o).then(i)})}},{key:"startTransaction",value:function(){var t=this,e=new j({repo:this.repo,from:this.branch,credentials:this.credentials,branch:"simpla-editing-"+o(),data:this.paths.data,uploads:this.paths.uploads});return function(e){return t._request("branches/"+e).then(function(t){return t.commit.sha})}(this.branch).then(function(n){return t._request("git/refs",{method:"POST",body:{ref:"refs/heads/"+e.branch,sha:n}})}).then(function(){return e})}},{key:"set",value:function(e,n){var r=this,o=u(n),i=m(o,2),a=i[0],s=function(t){return r._request("contents"+t+"?ref="+r.branch)},c=i[1].map(function(t){var e=m(t,2),n=e[0],o=e[1];return[r.paths.uploads+"/"+n,o]}).concat([[""+this.paths.data+e+".json",t(JSON.stringify(a,null,2))]]);return Promise.all(c.map(function(t){var e=m(t,2),n=e[0],o=e[1];return r._enqueue(function(){return s(n).then(function(t){var e=t.sha;return r._request("contents"+n,{method:"PUT",body:{message:"Updating "+n,branch:r.branch,path:n.slice(1),content:o,sha:e}})})})})).then(function(){return n})}},{key:"remove",value:function(t){var e=this,n=""+this.paths.data+t+".json",r=function(t){return e._request("contents"+t+"?ref="+e.branch)},o=function(r){var o=r.sha;return e._request("contents"+n,{method:"DELETE",body:{message:"Removing "+t,branch:e.branch,path:n.slice(1),sha:o}})};return this._enqueue(function(){return r(n).then(o).then(function(){return null})})}}]),e}(),j=function(t){function e(t){v(this,e);var n=b(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.from=t.from,n}return y(e,k),d(e,[{key:"commit",value:function(){var t=this,e=function(){return t._request("merges",{method:"POST",body:{message:"Merging editing branch",head:t.branch,base:t.from}})},n=function(){return t._request("git/refs/heads/"+t.branch,{method:"DELETE"})};return this._enqueue(function(){return e().then(n).then(h)})}}]),e}(),S=function(){function t(){v(this,t),this._observers={"*":[]},this._data={}}return d(t,[{key:"observe",value:function(t,e){var n=this;return this._observers[t]=(this._observers[t]||[]).concat(e),{unobserve:function(){n._observers[t]=n._observers[t].filter(function(t){return t!==e})}}}},{key:"set",value:function(t,e){var r=!n(this._data[t],e);if(this._data[t]=e,r){var o=this._observers[t],i=this._observers["*"];if(o)for(var a=0,u=o.length;a<u;a++)o[a](e,t);for(var s=0,c=i.length;s<c;s++)i[s](e,t)}}},{key:"get",value:function(t){return this._data[t]}},{key:"has",value:function(t){return t in this._data}},{key:"entries",value:function(){var t=[];for(var e in this._data)t.push([e,this.get(e)]);return t}},{key:"toObject",value:function(){return p({},this._data)}}]),t}();return new(function(){function t(){v(this,t),this._content=new S,this._states=new S,this._cache=new S,this.version="2.3.2"}return d(t,[{key:"init",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.repo,o=e.auth,i=e.public,a=void 0===i?"":i,u=e.branch,s=void 0===u?"master":u,c=e.source,h=void 0===c?"https://raw.githubusercontent.com/"+r+"/"+s+"/"+a:c,f=e._indexes,l=void 0===f?[]:f;h="/"===h.charAt(h.length-1)?h.slice(0,-1):h;var v="/_content/data",d="/_content/uploads";this._source=new w({data:h+v,uploads:h+d,cacheBusting:/\/\/raw\.githubusercontent\.com/.test(h)}),this._auth=o,this._storage=new k({data:a?"/"+a+v:v,uploads:a?"/"+a+d:d,repo:r,branch:s});var p=function(e,r){var o=t._states.get("buffer"),i=t._cache.get(r),a=!n(i&&i.data,e&&e.data);o[r]={modified:a},t._states.set("buffer",o)};this._content.observe("*",p),this._cache.observe("*",p),this.observeState("token",function(e){e?window.localStorage.setItem("sm.oss.token",e):window.localStorage.removeItem("sm.oss.token"),t._states.set("authenticated",!!e),t._storage.credentials={token:e}}),this._states.set("config",{repo:r,branch:s,public:a,source:h}),this._states.set("token",window.localStorage.getItem("sm.oss.token")||null),this._states.set("editable",!1),this._states.set("buffer",{}),l.forEach(function(e){var n=function(t,e){return new Date(e.createdAt)-new Date(t.createdAt)},r=e.name,o=e.filter;t.get("/_index/"+r).then(function(e){var i=new S;(e&&e.data||[]).forEach(function(t){return i.set(t.path,t)}),t._content.observe("*",function(t,e){o(t)?i.set(e,t):i.has(e)&&i.set(e,null)}),i.observe("*",function(){var e=i.entries().map(function(t){return m(t,2)[1]}).filter(function(t){return!!t}).sort(n);t._content.set("/_index/"+r,{data:e})})})})}},{key:"_fetch",value:function(t){var e=this;return this._cache.has(t)?Promise.resolve(this._cache.get(t)):this._source.get(t).then(function(n){return e._cache.set(t,n),n})}},{key:"getState",value:function(t){return t?this._states.get(t):this._states.toObject()}},{key:"editable",value:function(t){this._states.set("editable",t)}},{key:"observeState",value:function(t,e){return this._states.observe(t,e)}},{key:"get",value:function(t){var e=this;return this._content.has(t)?Promise.resolve(this._content.get(t)):this._fetch(t).then(function(n){return e._content.set(t,n),n})}},{key:"set",value:function(t,e){var o=this;return Promise.resolve().then(function(){return i(t),a(e),o.get(t)}).then(function(i){var a=function(t){return e&&i&&n(e[t],i[t])};if(e===i||a("data")&&a("type"))return i;if(null===e)return Promise.resolve(o._content.set(t,e));var u=p({type:null},i||{},e,{path:t});return i||(u.createdAt=(new Date).toISOString()),u.updatedAt=(new Date).toISOString(),o._content.set(t,r(u)),u})}},{key:"remove",value:function(t){return i(t),this.set(t,null)}},{key:"observe",value:function(t,e){return i(t),this._content.observe(t,e)}},{key:"login",value:function(){var t=this;return this._auth.authenticate().then(function(e){var n=e.token;t._states.set("token",n)})}},{key:"logout",value:function(){this._states.set("token",null)}},{key:"save",value:function(t){var e=this,n=this.getState("buffer"),r=(t?[[t,this._content.get(t)]]:this._content.entries()).filter(s(n));return Promise.resolve().then(function(){return t&&i(t),r.length?e._storage.startTransaction():Promise.resolve()}).then(function(t){return r.forEach(function(e){var n=m(e,2),r=n[0],o=n[1];null===o?t.remove(r):t.set(r,o)}),t.commit()}).then(function(){r.forEach(function(t){var n=m(t,2),r=n[0],o=n[1];e._content.set(r,o),e._cache.set(r,o)})})}},{key:"_loadDB",value:function(){var t=this;return this._storage.all().then(function(e){return Promise.all(e.map(function(e){return t.get(e)}))})}}]),t}())});
